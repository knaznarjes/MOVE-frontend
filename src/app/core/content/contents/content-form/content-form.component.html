<div class="container mx-auto p-4">
    <div class="bg-white rounded-lg shadow-lg p-6">
      <h1 class="text-2xl font-bold mb-6">
        {{ isEditing ? 'Edit Content' : 'Create New Content' }}
      </h1>

      <div *ngIf="isLoading" class="flex justify-center mb-4">
        <div class="spinner-border text-primary" role="status">
          <span class="sr-only">Loading...</span>
        </div>
      </div>

      <div *ngIf="submitError" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-4">
        {{ submitError }}
      </div>

      <form [formGroup]="contentForm" (ngSubmit)="onSubmit()" class="space-y-6">
        <!-- Basic Information Card -->
        <div class="card">
          <div class="card-header bg-primary text-white py-3">
            <h3 class="card-title mb-0">Basic Information</h3>
          </div>
          <div class="card-body p-4">
            <div class="row mb-3">
              <div class="col-md-6">
                <!-- Title -->
                <div class="form-group mb-3">
                  <label for="title" class="form-label">Title*</label>
                  <input
                    type="text"
                    id="title"
                    formControlName="title"
                    class="form-control"
                    [ngClass]="{'is-invalid': !isControlValid('title')}"
                  >
                  <div *ngIf="getFormControlError('title')" class="invalid-feedback">
                    {{ getFormControlError('title') }}
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <!-- Content Type -->
                <div class="form-group mb-3">
                  <label for="type" class="form-label">Content Type*</label>
                  <select
                    id="type"
                    formControlName="type"
                    class="form-select"
                    [ngClass]="{'is-invalid': !isControlValid('type')}"
                  >
                    <option *ngFor="let type of contentTypes" [value]="type">{{ type }}</option>
                  </select>
                  <div *ngIf="getFormControlError('type')" class="invalid-feedback">
                    {{ getFormControlError('type') }}
                  </div>
                </div>
              </div>
            </div>

            <div class="form-group mb-3">
              <label for="description" class="form-label">Description*</label>
              <textarea
                id="description"
                formControlName="description"
                class="form-control"
                rows="4"
                [ngClass]="{'is-invalid': !isControlValid('description')}"
              ></textarea>
              <div *ngIf="getFormControlError('description')" class="invalid-feedback">
                {{ getFormControlError('description') }}
              </div>
            </div>

            <div class="row mb-3" *ngIf="contentForm.get('type').value === 'Itinerary'">
              <div class="col-md-6">
                <!-- Start Date -->
                <div class="form-group">
                  <label for="startDate" class="form-label">Start Date*</label>
                  <input
                    type="date"
                    id="startDate"
                    formControlName="startDate"
                    class="form-control"
                    [ngClass]="{'is-invalid': !isControlValid('startDate')}"
                  >
                  <div *ngIf="getFormControlError('startDate')" class="invalid-feedback">
                    {{ getFormControlError('startDate') }}
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <!-- End Date -->
                <div class="form-group">
                  <label for="endDate" class="form-label">End Date*</label>
                  <input
                    type="date"
                    id="endDate"
                    formControlName="endDate"
                    class="form-control"
                    [ngClass]="{'is-invalid': !isControlValid('endDate')}"
                  >
                  <div *ngIf="getFormControlError('endDate')" class="invalid-feedback">
                    {{ getFormControlError('endDate') }}
                  </div>
                </div>
              </div>
            </div>

            <div class="row mb-3">
              <div class="col-md-6">
                <!-- Budget -->
                <div class="form-group">
                  <label for="budget" class="form-label">Budget ($)</label>
                  <input
                    type="number"
                    id="budget"
                    formControlName="budget"
                    class="form-control"
                    [ngClass]="{'is-invalid': !isControlValid('budget')}"
                  >
                  <div *ngIf="getFormControlError('budget')" class="invalid-feedback">
                    {{ getFormControlError('budget') }}
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <!-- Tags -->
                <div class="form-group">
                  <label for="tags" class="form-label">Tags</label>
                  <ng-select
                    [items]="availableTags"
                    [multiple]="true"
                    [closeOnSelect]="false"
                    [searchable]="true"
                    bindLabel="label"
                    bindValue="value"
                    placeholder="Select tags"
                    formControlName="tags"
                    (add)="addTag($event)"
                    [ngClass]="{'is-invalid': !isControlValid('tags')}"
                  >
                    <ng-template ng-label-tmp let-item="item" let-clear="clear">
                      <span class="ng-value-label">{{ item.label }}</span>
                      <span class="ng-value-icon right" (click)="clear(item)" aria-hidden="true">Ã—</span>
                    </ng-template>
                  </ng-select>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Cover Image Card -->
        <div class="card">
          <div class="card-header bg-primary text-white py-3">
            <h3 class="card-title mb-0">Cover Image</h3>
          </div>
          <div class="card-body p-4">
            <div class="mb-3">
              <label for="coverImage" class="form-label">Cover Image</label>
              <input
                type="file"
                id="coverImage"
                class="form-control"
                accept="image/*"
                (change)="uploadCoverImage($event)"
              >
            </div>

            <div *ngIf="isLoading && uploadProgress > 0" class="progress mb-3">
              <div
                class="progress-bar"
                role="progressbar"
                [style.width.%]="uploadProgress"
                [attr.aria-valuenow]="uploadProgress"
                aria-valuemin="0"
                aria-valuemax="100"
              >
                {{ uploadProgress }}%
              </div>
            </div>

            <div *ngIf="coverImagePreview" class="mt-3 text-center">
              <img [src]="coverImagePreview" alt="Cover Image Preview" class="img-fluid rounded" style="max-height: 200px;">
            </div>
          </div>
        </div>

        <!-- Locations Card -->
        <div class="card">
          <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Locations</h3>
            <button type="button" class="btn btn-light btn-sm" (click)="addLocation()">
              <i class="bi bi-plus"></i> Add Location
            </button>
          </div>
          <div class="card-body p-4">
            <div formArrayName="locations">
              <div *ngFor="let locationControl of locationsArray.controls; let i = index" class="mb-4 p-3 border rounded">
                <div [formGroupName]="i" class="row">
                  <div class="col-12 d-flex justify-content-end mb-2">
                    <button type="button" class="btn btn-sm btn-danger" (click)="removeLocation(i)">
                      <i class="bi bi-trash"></i> Remove
                    </button>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label [for]="'country-' + i" class="form-label">Country*</label>
                      <select
                        [id]="'country-' + i"
                        formControlName="country"
                        class="form-select"
                        [ngClass]="{'is-invalid': getFormControlError('locations[' + i + '].country')}"
                        (change)="onCountrySelected(locationControl, locationControl.get('country').value)"
                      >
                        <option value="" disabled selected>Select Country</option>
                        <option *ngFor="let country of countries" [value]="country.country">{{ country.country }}</option>
                      </select>
                      <div *ngIf="getFormControlError('locations[' + i + '].country')" class="invalid-feedback">
                        {{ getFormControlError('locations[' + i + '].country') }}
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label [for]="'address-' + i" class="form-label">Address*</label>
                      <input
                        type="text"
                        [id]="'address-' + i"
                        formControlName="address"
                        class="form-control"
                        [ngClass]="{'is-invalid': getFormControlError('locations[' + i + '].address')}"
                      >
                      <div *ngIf="getFormControlError('locations[' + i + '].address')" class="invalid-feedback">
                        {{ getFormControlError('locations[' + i + '].address') }}
                      </div>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label [for]="'lat-' + i" class="form-label">Latitude</label>
                      <input
                        type="number"
                        [id]="'lat-' + i"
                        formControlName="lat"
                        class="form-control"
                        readonly
                      >
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="form-group mb-3">
                      <label [for]="'lon-' + i" class="form-label">Longitude</label>
                      <input
                        type="number"
                        [id]="'lon-' + i"
                        formControlName="lon"
                        class="form-control"
                        readonly
                      >
                    </div>
                  </div>
                </div>
              </div>

              <div *ngIf="locationsArray.controls.length === 0" class="text-center p-4 border rounded bg-light">
                <p class="mb-0">No locations added yet. Click "Add Location" to begin.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Day Programs Card (for Itineraries) -->
        <div *ngIf="contentForm.get('type').value === 'Itinerary'" class="card">
          <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
            <h3 class="card-title mb-0">Itinerary Days</h3>
            <button type="button" class="btn btn-light btn-sm" (click)="addDayProgram()">
              <i class="bi bi-plus"></i> Add Day
            </button>
          </div>
          <div class="card-body p-4">
            <div formArrayName="dayPrograms">
              <div *ngFor="let dayControl of dayProgramsArray.controls; let dayIndex = index" class="mb-5">
                <div [formGroupName]="dayIndex" class="border rounded p-3">
                  <div class="d-flex justify-content-between align-items-center mb-3">
                    <h4 class="mb-0">Day {{ dayControl.get('dayNumber').value }}</h4>
                    <button type="button" class="btn btn-sm btn-danger" (click)="removeDayProgram(dayIndex)">
                      <i class="bi bi-trash"></i> Remove Day
                    </button>
                  </div>

                  <div class="form-group mb-4">
                    <label [for]="'day-description-' + dayIndex" class="form-label">Day Description*</label>
                    <textarea
                      [id]="'day-description-' + dayIndex"
                      formControlName="description"
                      class="form-control"
                      rows="3"
                      [ngClass]="{'is-invalid': getFormControlError('dayPrograms[' + dayIndex + '].description')}"
                    ></textarea>
                    <div *ngIf="getFormControlError('dayPrograms[' + dayIndex + '].description')" class="invalid-feedback">
                      {{ getFormControlError('dayPrograms[' + dayIndex + '].description') }}
                    </div>
                  </div>

                  <!-- Activities -->
                  <div class="card mb-3">
                    <div class="card-header bg-secondary text-white d-flex justify-content-between align-items-center">
                      <h5 class="mb-0">Activities</h5>
                      <button type="button" class="btn btn-sm btn-light" (click)="addActivity(dayIndex)">
                        <i class="bi bi-plus"></i> Add Activity
                      </button>
                    </div>
                    <div class="card-body">
                      <div [formArrayName]="'activities'">
                        <div *ngFor="let activityControl of getActivitiesArray(dayIndex).controls; let activityIndex = index" class="mb-4 border-bottom pb-4">
                          <div [formGroupName]="activityIndex">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                              <h6 class="mb-0">Activity {{ activityIndex + 1 }}</h6>
                              <button type="button" class="btn btn-sm btn-outline-danger" (click)="removeActivity(dayIndex, activityIndex)">
                                <i class="bi bi-trash"></i> Remove
                              </button>
                            </div>

                            <div class="row mb-3">
                              <div class="col-md-6">
                                <div class="form-group mb-3">
                                  <label [for]="'activity-name-' + dayIndex + '-' + activityIndex" class="form-label">Name*</label>
                                  <input
                                    type="text"
                                    [id]="'activity-name-' + dayIndex + '-' + activityIndex"
                                    formControlName="name"
                                    class="form-control"
                                    [ngClass]="{'is-invalid': !isActivityControlValid(dayIndex, activityIndex, 'name')}"
                                  >
                                  <div *ngIf="!isActivityControlValid(dayIndex, activityIndex, 'name')" class="invalid-feedback">
                                    Activity name is required
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group mb-3">
                                  <label [for]="'activity-category-' + dayIndex + '-' + activityIndex" class="form-label">Category</label>
                                  <input
                                    type="text"
                                    [id]="'activity-category-' + dayIndex + '-' + activityIndex"
                                    formControlName="category"
                                    class="form-control"
                                  >
                                </div>
                              </div>
                            </div>

                            <div class="form-group mb-3">
                              <label [for]="'activity-description-' + dayIndex + '-' + activityIndex" class="form-label">Description*</label>
                              <textarea
                                [id]="'activity-description-' + dayIndex + '-' + activityIndex"
                                formControlName="description"
                                class="form-control"
                                rows="2"
                                [ngClass]="{'is-invalid': !isActivityControlValid(dayIndex, activityIndex, 'description')}"
                              ></textarea>
                              <div *ngIf="!isActivityControlValid(dayIndex, activityIndex, 'description')" class="invalid-feedback">
                                Activity description is required
                              </div>
                            </div>

                            <div class="row mb-3">
                              <div class="col-md-6">
                                <div class="form-group mb-3">
                                  <label [for]="'activity-startTime-' + dayIndex + '-' + activityIndex" class="form-label">Start Time*</label>
                                  <input
                                    type="datetime-local"
                                    [id]="'activity-startTime-' + dayIndex + '-' + activityIndex"
                                    formControlName="startTime"
                                    class="form-control"
                                    [ngClass]="{'is-invalid': !isActivityControlValid(dayIndex, activityIndex, 'startTime')}"
                                  >
                                  <div *ngIf="!isActivityControlValid(dayIndex, activityIndex, 'startTime')" class="invalid-feedback">
                                    Start time is required
                                  </div>
                                </div>
                              </div>
                              <div class="col-md-6">
                                <div class="form-group mb-3">
                                  <label [for]="'activity-endTime-' + dayIndex + '-' + activityIndex" class="form-label">End Time*</label>
                                  <input
                                    type="datetime-local"
                                    [id]="'activity-endTime-' + dayIndex + '-' + activityIndex"
                                    formControlName="endTime"
                                    class="form-control"
                                    [ngClass]="{'is-invalid': !isActivityControlValid(dayIndex, activityIndex, 'endTime')}"
                                  >
                                  <div *ngIf="!isActivityControlValid(dayIndex, activityIndex, 'endTime')" class="invalid-feedback">
                                    End time is required
                                  </div>
                                </div>
                              </div>
                            </div>

                            <div class="row mb-3">
                              <div class="col-md-4">
                                <div class="form-group mb-3">
                                  <label [for]="'activity-cost-' + dayIndex + '-' + activityIndex" class="form-label">Cost ($)</label>
                                  <input
                                    type="number"
                                    [id]="'activity-cost-' + dayIndex + '-' + activityIndex"
                                    formControlName="cost"
                                    class="form-control"
                                  >
                                </div>
                              </div>
                              <div class="col-md-4">
                                <div class="form-group mb-3">
                                  <label [for]="'activity-difficulty-' + dayIndex + '-' + activityIndex" class="form-label">Difficulty</label>
                                  <select
                                    [id]="'activity-difficulty-' + dayIndex + '-' + activityIndex"
                                    formControlName="difficulty"
                                    class="form-select"
                                  >
                                    <option value="EASY">Easy</option>
                                    <option value="MODERATE">Moderate</option>
                                    <option value="DIFFICULT">Difficult</option>
                                  </select>
                                </div>
                              </div>
                              <div class="col-md-4">
                                <div class="form-group mb-3">
                                  <label [for]="'activity-contactInfo-' + dayIndex + '-' + activityIndex" class="form-label">Contact Info</label>
                                  <input
                                    type="text"
                                    [id]="'activity-contactInfo-' + dayIndex + '-' + activityIndex"
                                    formControlName="contactInfo"
                                    class="form-control"
                                  >
                                </div>
                              </div>
                            </div>

                            <!-- Activity Location -->
                            <div class="card">
                              <div class="card-header bg-light">Activity Location</div>
                              <div class="card-body" formGroupName="location">
                                <div class="row mb-3">
                                  <div class="col-md-6">
                                    <div class="form-group mb-3">
                                      <label [for]="'activity-country-' + dayIndex + '-' + activityIndex" class="form-label">Country*</label>
                                      <select
                                        [id]="'activity-country-' + dayIndex + '-' + activityIndex"
                                        formControlName="country"
                                        class="form-select"
                                        [ngClass]="{'is-invalid': !isLocationControlValid(dayIndex, activityIndex, 'country')}"
                                        (change)="onCountrySelected(activityControl.get('location'), activityControl.get('location').get('country').value)"
                                      >
                                        <option value="" disabled selected>Select Country</option>
                                        <option *ngFor="let country of countries" [value]="country.country">{{ country.country }}</option>
                                      </select>
                                      <div *ngIf="!isLocationControlValid(dayIndex, activityIndex, 'country')" class="invalid-feedback">
                                        Country is required
                                      </div>
                                    </div>
                                  </div>
                                  <div class="col-md-6">
                                    <div class="form-group mb-3">
                                      <label [for]="'activity-address-' + dayIndex + '-' + activityIndex" class="form-label">Address*</label>
                                      <input
                                        type="text"
                                        [id]="'activity-address-' + dayIndex + '-' + activityIndex"
                                        formControlName="address"
                                        class="form-control"
                                        [ngClass]="{'is-invalid': !isLocationControlValid(dayIndex, activityIndex, 'address')}"
                                      >
                                      <div *ngIf="!isLocationControlValid(dayIndex, activityIndex, 'address')" class="invalid-feedback">
                                        Address is required
                                      </div>
                                    </div>
                                  </div>
                                </div>

                                <div class="row">
                                  <div class="col-md-6">
                                    <div class="form-group mb-3">
                                      <label [for]="'activity-lat-' + dayIndex + '-' + activityIndex" class="form-label">Latitude</label>
                                      <input
                                        type="number"
                                        [id]="'activity-lat-' + dayIndex + '-' + activityIndex"
                                        formControlName="lat"
                                        class="form-control"
                                        readonly
                                      >
                                    </div>
                                  </div>
                                  <div class="col-md-6">
                                    <div class="form-group mb-3">
                                      <label [for]="'activity-lon-' + dayIndex + '-' + activityIndex" class="form-label">Longitude</label>
                                      <input
                                        type="number"
                                        [id]="'activity-lon-' + dayIndex + '-' + activityIndex"
                                        formControlName="lon"
                                        class="form-control"
                                        readonly
                                      >
                                    </div>
                                  </div>
                                </div>
                              </div>
                            </div>
                          </div>
                        </div>

                        <div *ngIf="getActivitiesArray(dayIndex).controls.length === 0" class="text-center p-3 bg-light rounded">
                          <p class="mb-0">No activities added yet. Click "Add Activity" to begin.</p>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div *ngIf="dayProgramsArray.controls.length === 0" class="text-center p-4 border rounded bg-light">
                <p class="mb-0">No days added yet. Click "Add Day" to begin creating your itinerary.</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="d-flex justify-content-between">
          <button type="button" class="btn btn-secondary" [routerLink]="['/content']">Cancel</button>
          <div>
            <button *ngIf="isEditing && contentId" type="button" class="btn btn-warning me-2" (click)="publishContent()">
              Publish
            </button>
            <button *ngIf="isEditing && contentId" type="button" class="btn btn-outline-warning me-2" (click)="unpublishContent()">
              Unpublish
            </button>
            <button type="submit" class="btn btn-primary" [disabled]="isSubmitting">
              {{ isSubmitting ? 'Saving...' : (isEditing ? 'Update' : 'Create') }}
            </button>
          </div>
        </div>
      </form>
    </div>
  </div>
